// Copyright 2024 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package valkey_timeseries.fanout;


message DateRange {
  int64 start = 1;
  int64 end = 2;
}

message MetaDateRangeFilter {
  int64 start = 1;
  int64 end = 2;
  bool exclude = 3;
}

message ValueRange {
  double min = 1;
  double max = 2;
}

enum MatcherOpType {
  EQUAL = 0;
  NOT_EQUAL = 1;
  REGEX_EQUAL = 2;
  REGEX_NOT_EQUAL = 3;
}

enum MatchersConnector  {
  AND = 0;
  OR = 1;
}

message FilterListValue {
  repeated string values = 1;
}

message FilterPredicateValue {
  oneof label_value {
    string value = 1;
    FilterListValue values = 2;
  }
}

message LabelFilter {
  string label = 1;
  MatcherOpType op = 2;
  oneof value {
    bool empty = 3;
    string single = 4;
    FilterListValue list = 5;
  }
}

message FilterList {
  repeated LabelFilter matchers = 1;
}

message OrMatcherList {
  repeated FilterList filters = 1;
}

message SeriesSelector {
  oneof filters {
    FilterList and_filters = 2;
    OrMatcherList or_filters = 3;
  }
}

message MultiGetRequest {
  bool with_labels = 1;
  repeated string selected_labels = 2;
  repeated SeriesSelector filters = 3;
  bool latest = 4;
}

message MDelRequest {
  DateRange range = 1;
  repeated SeriesSelector filters = 2;
}


message RangeRequest {
  DateRange range = 1;
  uint32 count = 2;
  repeated int64 timestamp_filter = 3;
  ValueRange value_filter = 4;
  optional AggregationOptions aggregation = 5;
  bool latest = 6;
}

message IndexQueryRequest {
  MetaDateRangeFilter range = 1;
  repeated SeriesSelector filters = 2;
}

message LabelNamesRequest {
  MetaDateRangeFilter range = 1;
  repeated SeriesSelector filters = 2;
}

message LabelValuesRequest {
  string label = 1;
  MetaDateRangeFilter range = 2;
  repeated SeriesSelector filters = 3;
}

message CardinalityRequest {
  MetaDateRangeFilter range = 1;
  repeated SeriesSelector filters = 2;
}

message MetadataRequest {
  MetaDateRangeFilter filter = 1;
  repeated SeriesSelector filters = 2;
  uint32 limit = 3;
}

message SearchQueryRequest {
  int64 start = 1;
  int64 end = 2;
  SeriesSelector filters = 3;
  uint32 limit = 4;
}

message StatsRequest {
  uint32 limit = 1;
  optional string selected_label = 2;
}

message ClusterMessage {
  uint64 request_id = 1;
  int32 db = 2;
}

enum AggregationType {
  ALL = 0;
  ANY = 1;
  AVG = 2;
  COUNT = 3;
  COUNT_IF = 4;
  FIRST = 5;
  INCREASE = 6;
  IRATE = 7;
  LAST = 8;
  MAX = 9;
  MIN = 10;
  NONE = 11;
  SHARE_IF = 12;
  SUM = 13;
  SUM_IF = 14;
  RANGE = 15;
  RATE = 16;
  STD_S = 17;
  STD_P = 18;
  VAR_S = 19;
  VAR_P = 20;
}

enum ComparisonOperator {
  GT = 0;
  GTE = 1;
  LT = 2;
  LTE = 3;
  EQ = 4;
  NEQ = 5;
}

message ValueComparisonFilter {
  ComparisonOperator operator = 1;
  double value = 2;
}

message AggregatorConfig {
  AggregationType aggregator_type = 1;
  ValueComparisonFilter value_filter = 2;
}

message GroupingOptions {
  string group_label = 1;
  AggregatorConfig aggregation = 2;
}

enum BucketTimestampType {
  START = 0;
  END = 1;
  MID = 2;
}

enum BucketAlignmentType {
  DEFAULT = 0;
  ALIGN_START = 1;
  ALIGN_END = 2;
  TIMESTAMP = 3;
}

message AggregationOptions {
  AggregatorConfig aggregator = 1;
  uint32 bucket_duration = 2;
  int64 alignment_timestamp = 3;
  BucketTimestampType bucket_timestamp_type = 4;
  BucketAlignmentType bucket_alignment = 5;
  bool report_empty = 6;
}

message MultiRangeRequest {
  RangeRequest range = 1;
  repeated SeriesSelector filters = 2;
  optional GroupingOptions grouping = 3;
  bool with_labels = 4;
  repeated string selected_labels = 5;
  bool is_reverse = 6;
}